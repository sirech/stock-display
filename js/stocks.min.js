var app={modifiers:{name:"n",symbol:"s",last_price:"l1",last_time:"t1",percent_change:"p2",change:"c1"},format:{},stocks:loadStocks(),template:stockTemplate(),chartArguments:{today:"b",lastWeek:"w",threeMonths:"3m",sixMonths:"6m",lastYear:"1y"}};function buildModifiers(){app.format={last_time:0,name:1,last_price:2,percent_change:3,change:4,symbol:5};return app.modifiers.last_time+app.modifiers.name+app.modifiers.last_price+app.modifiers.percent_change+app.modifiers.change+app.modifiers.symbol}
function buildRequest(b){var a,d;a=[];for(d=0;d<b.length;d++)a.push(b[d].id);return"http://download.finance.yahoo.com/d/quotes.csv?s="+a.join("+")+"&f="+buildModifiers()}function sendRequest(b){$.get(b,function(a){present(a)})}function refresh(b){app.stocks.length!==0&&sendRequest(buildRequest(b))}
function buildChartRequest(b,a){var d,c="http://ichart.finance.yahoo.com/";if(a===app.chartArguments.today||a===app.chartArguments.lastWeek){c+=a+"?s=";d="&"}else{c+="c/"+a+"/";d="?"}return c+b+d+Math.floor(Math.random()*1E6)}
function showChart(b,a){var d,c;d=app.chartArguments[localStorage.time]||app.chartArguments.today;$("#chart").data("id",b);$("#chart ul").find("#"+localStorage.time).addClass("ui-state-active").siblings().removeClass("ui-state-active");c=new Image;c.src=buildChartRequest(b,d);c.onload=function(){$("#chart img").remove();a?$("#chart").append(c):$("#chart").append(c).effect("slide")}}
function prepareStock(b){var a=app.template.clone().data("id",b.id).show();a.find(".stock_name").text(b.name);a.click(function(){$(this).addClass("selected").siblings().removeClass("selected");showChart($(this).data("id"));return false}).mouseenter(function(){$(this).addClass("highlighted").siblings().removeClass("highlighted");return false});a.find(".stock_chg").click(function(){togglePrice();return false});return a}
function prepareList(){var b,a;if(app.stocks.length===0){showEmptyMsg();return false}for(b=0;b<app.stocks.length;b++){a=prepareStock(app.stocks[b]);$("#stocks ul").append(a)}return true}
function present(b){var a,d,c,e,f;a=csvToArray(b);d=0;c=(b=getBoolKey($("#stocks"),"price_chg"))?app.format.change:app.format.percent_change;e=b?app.format.percent_change:app.format.change;$("#stocks ul .stock").each(function(i,h){var g=a[d];if(g[app.format.symbol]===$(h).data("id")){f=g[c].charAt(0)==="+"?"up":g[c].charAt(0)==="-"?"down":"neutral";$(h).find(".stock_price").text(g[app.format.last_price]);$(h).find(".stock_chg").removeClass("up down neutral").addClass(f).data("alt",g[e]).text(g[c]);
d++}else{$(h).find(".stock_price").text("-");$(h).find(".stock_chg").removeClass("up down neutral").addClass("neutral").data("alt","-").text("-")}});$("#chart img").length!=0&&showChart($("#chart").data("id"),true)}function showEmptyMsg(){$("#empty").show().find("a").click(function(){window.open(chrome.extension.getURL("options.html"));window.close();return false});$("#title").hide();$("#disclaimer").hide();$("#last_update").hide()}
function togglePrice(){toggleKey($("#stocks"),"price_chg");$("#stocks ul .stock .stock_chg").each(function(b,a){swap($(a),"alt")})}function yahooTimeToDate(b){var a,d;a=b.slice(-2).toLowerCase();d=b.slice(0,-2).split(":");b=new Date;b.setHours(function(c,e){return e?c%12+12:c%12}(parseInt(d[0],10),a==="pm"));b.setMinutes(parseInt(d[1],10));b.setSeconds(0);a=240-b.getTimezoneOffset();a=b.getTime()+a*60*1E3;return new Date(a)}
function csvToArray(b,a){var d,c,e,f;a=a||",";d=RegExp("(\\"+a+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+a+"\\r\\n]*))","gi");for(c=[[]];e=d.exec(b);){f=e[1];f.length&&f!==a&&c.push([]);e=e[2]?e[2].replace(RegExp('""',"g"),'"'):e[3];c[c.length-1].push(e)}return c}
jQuery(function(){$("#status").ajaxStart(function(){$(this).show()});$("#status").ajaxStop(function(){$(this).fadeOut(2E3)});$("#title").click(function(){window.open(chrome.extension.getURL("standalone.html"));window.close();return false}).mouseenter(function(){$(this).addClass("title_highlight");return false}).mouseleave(function(){$(this).removeClass("title_highlight");return false}).attr("title",chrome.i18n.getMessage("help_standalone")).text(getTitle());$("#disclaimer").text(chrome.i18n.getMessage("disclaimer"));
$("#empty a").text(chrome.i18n.getMessage("empty_add"));$("#time_options li").addClass("ui-state-default").click(function(){localStorage.time=$(this).attr("id");showChart($("#chart").data("id"));return false});if(prepareList()){refresh(app.stocks);window.setInterval(function(){refresh(app.stocks)},3E4)}});
