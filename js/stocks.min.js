var app={modifiers:{name:"n",last_price:"l1",last_time:"t1",percent_change:"p2",change:"c1"},format:{},stocks:loadStocks(),template:stockTemplate(),chartArguments:{today:"b",lastWeek:"w",threeMonths:"3m",sixMonths:"6m",lastYear:"1y"}};function buildModifiers(){app.format={last_time:0,name:1,last_price:2,percent_change:3,change:4};return app.modifiers.last_time+app.modifiers.name+app.modifiers.last_price+app.modifiers.percent_change+app.modifiers.change}
function buildRequest(b){var a,c;a=[];for(c=0;c<b.length;c++)a.push(b[c].id);return"http://download.finance.yahoo.com/d/quotes.csv?s="+a.join("+")+"&f="+buildModifiers()}function sendRequest(b){$.get(b,function(a){present(a)})}function refresh(b){app.stocks.length!==0&&sendRequest(buildRequest(b))}function buildChartRequest(b,a){var c="http://ichart.finance.yahoo.com/";c+=a===app.chartArguments.today||a===app.chartArguments.lastWeek?a+"?s=":"c/"+a+"/";return c+b}
function showChart(b){var a,c;a=localStorage.time||app.chartArguments.today;c=new Image;c.src=buildChartRequest(b,a);c.onload=function(){$("#chart img").remove();$("#chart").append(c).effect("slide")}}
function prepareStock(b){var a=app.template.clone().data("id",b.id).show();a.find(".stock_name").text(b.name);a.click(function(){$(this).addClass("selected").siblings().removeClass("selected");showChart($(this).data("id"));return false}).mouseenter(function(){$(this).addClass("highlighted").siblings().removeClass("highlighted");return false});a.find(".stock_chg").click(function(){togglePrice();return false});return a}
function prepareList(){var b,a;if(app.stocks.length===0){showEmptyMsg();return false}for(b=0;b<app.stocks.length;b++){a=prepareStock(app.stocks[b]);$("#stocks ul").append(a)}return true}
function present(b){var a,c,d,e,f;a=csvToArray(b);c=0;d=(b=getBoolKey($("#stocks"),"price_chg"))?app.format.change:app.format.percent_change;e=b?app.format.percent_change:app.format.change;$("#stocks ul .stock").each(function(i,h){var g=a[c];f=g[d].charAt(0)==="+"?"up":g[d].charAt(0)==="-"?"down":"neutral";$(h).find(".stock_price").text(g[app.format.last_price]);$(h).find(".stock_chg").removeClass("up down neutral").addClass(f).data("alt",g[e]).text(g[d]);c++})}
function showEmptyMsg(){$("#empty").show().find("a").click(function(){window.open(chrome.extensions.getURL("options.html"));window.close();return false});$("#title").hide();$("#disclaimer").hide();$("#last_update").hide()}function togglePrice(){toggleKey($("#stocks"),"price_chg");$("#stocks ul .stock .stock_chg").each(function(b,a){swap($(a),"alt")})}
function yahooTimeToDate(b){var a,c;a=b.slice(-2).toLowerCase();c=b.slice(0,-2).split(":");b=new Date;b.setHours(function(d,e){return e?d%12+12:d%12}(parseInt(c[0],10),a==="pm"));b.setMinutes(parseInt(c[1],10));b.setSeconds(0);a=240-b.getTimezoneOffset();a=b.getTime()+a*60*1E3;return new Date(a)}
function csvToArray(b,a){var c,d,e,f;a=a||",";c=RegExp("(\\"+a+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+a+"\\r\\n]*))","gi");for(d=[[]];e=c.exec(b);){f=e[1];f.length&&f!==a&&d.push([]);e=e[2]?e[2].replace(RegExp('""',"g"),'"'):e[3];d[d.length-1].push(e)}return d}
jQuery(function(){$("#status").ajaxStart(function(){$(this).show()});$("#status").ajaxStop(function(){$(this).fadeOut(2E3)});$("#title").text(chrome.i18n.getMessage("title"));$("#disclaimer").text(chrome.i18n.getMessage("disclaimer"));$("#empty a").text(chrome.i18n.getMessage("empty_add"));if(prepareList()){refresh(app.stocks);window.setInterval(function(){refresh(app.stocks)},3E4)}});
